<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Диагностика распознавания чисел</title>
<style>
  body { font-family: sans-serif; padding: 1rem; background: #222; color: #eee; }
  button { font-size: 1.2rem; padding: 0.5rem 1rem; }
  #status { margin-top: 1rem; font-weight: bold; }
  #alternatives { margin-top: 0.5rem; font-size: 0.9rem; color: #ccc; }
  #hint { margin-top: 1rem; color: #f55; font-weight: 600; }
</style>
</head>
<body>

<h1>Голосное распознавание числа (0–9)</h1>
<button id="start-btn">Начать распознавание</button>
<div id="status">Нажмите кнопку и скажите число от 0 до 9</div>
<div id="alternatives"></div>
<div id="hint"></div>

<script>
(() => {
  const startBtn = document.getElementById('start-btn');
  const statusEl = document.getElementById('status');
  const altEl = document.getElementById('alternatives');
  const hintEl = document.getElementById('hint');

  let recognition = null;
  let listening = false;

  function parseSpokenNumber(str) {
    str = str.trim().toLowerCase();

    const numbersMap = {
      'ноль': 0,
      'один': 1,
      'одна': 1,
      'два': 2,
      'две': 2,
      'три': 3,
      'четыре': 4,
      'пять': 5,
      'пяять': 5, // часто ошибка
      'шесть': 6,
      'семь': 7,
      'восемь': 8,
      'восем': 8, // возможная ошибка
      'девять': 9,
    };

    // Попытка найти число в цифрах
    const digitsMatch = str.match(/\d+/);
    if (digitsMatch) {
      const num = Number(digitsMatch[0]);
      if (!Number.isNaN(num) && num >= 0 && num <= 9) return num;
    }

    // Полное совпадение
    if (numbersMap.hasOwnProperty(str)) {
      return numbersMap[str];
    }

    // Частичное совпадение (если распозналось с ошибкой)
    for (const [word, num] of Object.entries(numbersMap)) {
      if (str.includes(word)) return num;
    }

    return null;
  }

  function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert('Ваш браузер не поддерживает Web Speech API. Используйте Chrome или Edge.');
      startBtn.disabled = true;
      return null;
    }
    const recog = new SpeechRecognition();
    recog.lang = 'ru-RU';
    recog.interimResults = false;
    recog.maxAlternatives = 5;
    recog.continuous = false;
    return recog;
  }

  function startListening() {
    if (!recognition) return;
    listening = true;
    statusEl.textContent = 'Слушаю... Говорите число от 0 до 9';
    altEl.textContent = '';
    hintEl.textContent = '';
    startBtn.textContent = 'Остановить';
    startBtn.disabled = false;
    try {
      recognition.start();
    } catch(e) {}
  }

  function stopListening() {
    if (!recognition) return;
    listening = false;
    recognition.stop();
    startBtn.textContent = 'Начать распознавание';
    statusEl.textContent = 'Распознавание остановлено.';
  }

  startBtn.addEventListener('click', () => {
    if (listening) {
      stopListening();
    } else {
      startListening();
    }
  });

  recognition = initRecognition();
  if (recognition) {
    recognition.addEventListener('result', (event) => {
      if (!event.results || event.results.length === 0) {
        statusEl.textContent = 'Не распознано. Попробуйте ещё раз.';
        return;
      }
      const result = event.results[0];
      const transcript = result[0].transcript.trim().toLowerCase();

      // Выводим все альтернативы
      const alternatives = [];
      for (let i = 0; i < result.length; i++) {
        alternatives.push(result[i].transcript.trim());
      }
      altEl.textContent = 'Варианты распознавания: ' + alternatives.join(', ');

      statusEl.textContent = `Вы сказали: "${transcript}"`;

      const num = parseSpokenNumber(transcript);
      if (num === null) {
        hintEl.textContent = 'Не удалось распознать число от 0 до 9. Попробуйте сказать цифру или слово.';
      } else {
        hintEl.textContent = `Распознано число: ${num}`;
      }
    });

    recognition.addEventListener('error', (e) => {
      hintEl.textContent = `Ошибка распознавания: ${e.error}`;
      if (e.error === 'not-allowed' || e.error === 'permission-denied') {
        statusEl.textContent = 'Доступ к микрофону запрещён.';
        stopListening();
      }
    });

    recognition.addEventListener('end', () => {
      if (listening) {
        // Автоматически перезапускаем распознавание, если нужно
        setTimeout(() => recognition.start(), 300);
      }
    });
  }
})();
</script>

</body>
</html>
